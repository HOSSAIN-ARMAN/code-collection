<?php


namespace SkylarkSoft\GoRMG\Settings\Controllers;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use SkylarkSoft\GoRMG\Settings\Models\Color;
use SkylarkSoft\GoRMG\Settings\Requests\ColorRequest;
use SkylarkSoft\GoRMG\Settings\Traits\ManageData;

class ColorController extends Controller
{
    use ManageData;

    private $path = 'colors', $message, $formPage = 'settings::forms.colors', $index='color';

    function model(){
        return new Color();
    }

    public function index(Request $request)
    {
        $this->message = $this->model()->filter($request->query('search'))->orderBy('created_at', 'DESC')->paginate();
        return view('settings::pages.colors', ['colors' => $this->message]);
    }


    public function create()
    {
        return view($this->formPage, [$this->index => $this->model()]);
    }

    public function store(ColorRequest $request)
    {
        return $this->updateOrStoreOrDestroy($request->all(), $this->model(), $this->path, $this->message='Data Stored Successfully!!');
    }


    public function edit($id)
    {
        return view($this->formPage, [$this->index => $this->model()->findOrFail($id)]);
    }


    public function update(ColorRequest $request, Color $color)
    {
        return $this->updateOrStoreOrDestroy($request->except('_token', '_method'), $color, $this->path, $this->message='Data Update Successfully!!');
    }


    public function destroy($id)
    {
        return $this->updateOrStoreOrDestroy(null, $this->model()->findOrFail($id), $this->path, $this->message = 'Data Deleted Successfully!!');
    }

}



------------------------------------------------------------------------------------------------------------------------>

<?php
namespace SkylarkSoft\GoRMG\Settings\Traits;

use Illuminate\Support\Facades\Session;
use DB,Exception;

trait ManageData {

    public function updateOrStoreOrDestroy($request, $model, $path, $message)
    {
        try {
            if ($request == null){
                DB::beginTransaction();
                $model->delete();
                DB::commit();
            }else{
                DB::beginTransaction();
                $model->fill($request)->save();
                DB::commit();
            }
            Session::flash('alert-success', $message);
            return redirect($path);
        } catch (\Exception $e) {
            DB::rollback();
            Session::flash('alert-danger', "Something went wrong!{$e->getMessage()}");
            return redirect()->back();
        }


    }
}




--------------------------------- 2 ----------------------------------------------->


âœ… Best version of your pattern
Trait
trait ManageData
{
    public function persist(Model $model, ?array $data)
    {
        return DB::transaction(function () use ($model, $data) {

            if ($data === null) {
                return $model->delete();
            }

            return $model->fill($data)->save();
        });
    }
}

Controller
// store
$this->persist(new Color(), $request->validated());

// update
$this->persist($color, $request->validated());

// delete
$this->persist($color, null);


Now:

null clearly means delete

Method name reflects persistence

No confusion about request object

This is a clean compromise.

--------------------------------- 3 ----------------------------------------------->

1ï¸âƒ£ BaseMasterCrudController
2ï¸âƒ£ Guardrails (so nobody misuses it)
3ï¸âƒ£ Safe ManageData trait (final form)
4ï¸âƒ£ How to use it in Color / Category / Doctor controllers
5ï¸âƒ£ Minimal tests to lock behavior

No over-engineering, no packages.

1ï¸âƒ£ BaseMasterCrudController (foundation)

This controller is ONLY for master / lookup data.

<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Database\Eloquent\Model;

abstract class BaseMasterCrudController extends Controller
{
    protected string $viewPath;
    protected string $routePath;
    protected string $formView;
    protected string $modelKey;

    abstract protected function model(): Model;

    public function index(Request $request)
    {
        $items = $this->model()
            ->latest()
            ->paginate();

        return view($this->viewPath, [
            $this->modelKey . 's' => $items
        ]);
    }

    public function create()
    {
        return view($this->formView, [
            $this->modelKey => $this->model()
        ]);
    }

    public function edit($id)
    {
        return view($this->formView, [
            $this->modelKey => $this->model()->findOrFail($id)
        ]);
    }
}


ğŸ“Œ This already removes 50â€“60% controller duplication

2ï¸âƒ£ Guardrails (VERY important)
Rule #1 â€” Explicit marker trait
trait MasterDataOnly {}


Use it in models that are allowed:

class Color extends Model
{
    use MasterDataOnly;

    protected $fillable = ['name', 'code'];
}


âŒ OPD, Billing, Payment models will NOT use this trait.

Rule #2 â€” Runtime protection (hard stop)

Inside ManageData:

if (! in_array(MasterDataOnly::class, class_uses($model))) {
    throw new \LogicException('This trait is only for MASTER DATA');
}


ğŸ’¥ If someone tries to use it for OPD â†’ app crashes loudly (good).

3ï¸âƒ£ Final ManageData Trait (clean & safe)
<?php

namespace App\Traits;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Facades\DB;

trait ManageData
{
    protected function persist(Model $model, ?array $data)
    {
        if (! in_array(\App\Traits\MasterDataOnly::class, class_uses($model))) {
            throw new \LogicException('ManageData used outside master data');
        }

        return DB::transaction(function () use ($model, $data) {

            // DELETE
            if ($data === null) {
                return $model->delete();
            }

            // CREATE or UPDATE
            $model->fill($data);

            // Multi-tenant safety
            if (method_exists($model, 'setTenant')) {
                $model->setTenant();
            }

            return $model->save();
        });
    }
}

4ï¸âƒ£ ColorController (final version)
class ColorController extends BaseMasterCrudController
{
    use ManageData;

    protected string $viewPath = 'settings::pages.colors';
    protected string $formView = 'settings::forms.colors';
    protected string $routePath = 'colors';
    protected string $modelKey = 'color';

    protected function model(): Model
    {
        return new Color();
    }

    public function store(ColorRequest $request)
    {
        $this->persist(new Color(), $request->validated());

        return redirect($this->routePath)
            ->with('success', 'Color created successfully');
    }

    public function update(ColorRequest $request, Color $color)
    {
        $this->persist($color, $request->validated());

        return redirect($this->routePath)
            ->with('success', 'Color updated successfully');
    }

    public function destroy(Color $color)
    {
        $this->persist($color, null);

        return redirect($this->routePath)
            ->with('success', 'Color deleted successfully');
    }
}


ğŸ§  Intent is now:

Explicit

Safe

Still DRY

Still fast to write

5ï¸âƒ£ Tenant Safety (one-liner helper)

In model:

public function setTenant()
{
    $this->tenant_id = auth()->user()->tenant_id;
}


Now ManageData automatically protects tenant data.

6ï¸âƒ£ Minimal Tests (locks behavior ğŸ”’)
Create test
public function test_master_data_can_be_created()
{
    $color = Color::create([
        'name' => 'Red',
        'code' => '#FF0000'
    ]);

    $this->assertDatabaseHas('colors', ['name' => 'Red']);
}

Delete test
public function test_master_data_can_be_deleted()
{
    $color = Color::factory()->create();

    $this->assertTrue($color->delete());
}

Guardrail test (IMPORTANT)
public function test_manage_data_cannot_be_used_for_opd()
{
    $this->expectException(\LogicException::class);

    $trait = new class {
        use ManageData;
    };

    $trait->persist(new Opd(), ['test' => 'x']);
}


This test guarantees:
âŒ Nobody can use this for OPD/billing accidentally.






